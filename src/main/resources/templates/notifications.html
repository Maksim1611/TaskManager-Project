<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - TaskFlow</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/notifications.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body class="dashboard-page">
<aside class="sidebar" xmlns:sec="http://www.w3.org/1999/xhtml">
    <div class="sidebar-header">
        <h1 class="logo">TaskFlow</h1>
    </div>

    <nav class="nav">
        <a href="/dashboard" class="nav-link">
            <i class="fas fa-home"></i>
            Dashboard
        </a>
        <a href="/projects" class="nav-link">
            <i class="fas fa-folder"></i>
            Projects
        </a>
        <a href="/tasks" class="nav-link ">
            <i class="fas fa-tasks"></i>
            Tasks
        </a>
        <a href="/activity" class="nav-link">
            <i class="fas fa-chart-line"></i>
            Activity
        </a>
        <a href="/analytics" class="nav-link">
            <i class="fa-solid fa-chart-simple"></i>
            Analytics
        </a>
        <a href="/notifications" class="nav-link active">
            <i class="fas fa-bell"></i>
            Notifications
        </a>
        <a th:href="@{'/users/' + ${user.id} + '/profile'}" class="nav-link">
            <i class="fas fa-cog"></i>
            Settings
        </a>
        <div sec:authorize="hasRole('ADMIN')">
            <a href="/users" class="nav-link">
                <i class="fa-solid fa-user"></i>
                Users
            </a>
        </div>
        <div sec:authorize="hasAnyRole('ADMIN','MODERATOR')">
            <a href="/notifications/sender" class="nav-link">
                <i class="fa-solid fa-bullhorn"></i>
                Alerts
            </a>
        </div>
    </nav>

    <div class="user-profile">
        <img th:if="${base64Image != null}"
             th:src="'data:image/png;base64,' + ${base64Image}"
             class="user-avatar"
             alt="User Avatar">

        <div th:if="${base64Image == null}"
             th:text="${user.firstName.substring(0,1)} + ${user.lastName.substring(0,1)}"
             class="user-avatar">MS
        </div>

        <div class="user-info">
            <div th:text="${user.firstName + ' ' + user.lastName}" class="name"></div>
            <div th:text="${user.email}" class="email"></div>
        </div>

        <form th:action="@{/logout}" method="post">
            <button type="submit" class="logout-btn">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </form>
    </div>
</aside>


<main>
    <div class="page-container">
        <div class="main-content">
            <div class="page-header">
                <div class="page-title-container">
                    <div class="page-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div>
                        <h1 class="page-title">Notifications</h1>
                        <p class="page-subtitle">Manage your notifications and preferences</p>
                    </div>
                </div>
                <div class="header-actions">
                    <form th:action="@{/notifications/history}" th:method="DELETE" style="display: inline;">
                        <button type="submit" class="btn btn-danger delete-history-btn">
                            <i class="fas fa-trash-alt"></i>
                            Clear History
                        </button>
                    </form>
                </div>
            </div>
            <div class="notifications-layout">
                <div class="notifications-card">
                    <table class="notifications-table">
                        <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:unless="${notifications.isEmpty()}" th:each="notification : ${notifications}">
                            <td>
                                <div th:text="${notification.subject}" class="font-medium text-gray-900">Task
                                    Assignment: Complete Project Proposal
                                </div>
                            </td>
                            <td>
                                <span th:if="${notification.type.name() == 'DEADLINE'}" class="type-pill type-deadline">DEADLINE</span>
                                <span th:if="${notification.type.name() == 'SUMMARY'}" class="type-pill type-summary">SUMMARY</span>
                                <span th:if="${notification.type.name() == 'EMAIL'}" class="type-pill type-email">EMAIL</span>
                                <span th:if="${notification.type.name() == 'REMINDER'}" class="type-pill type-reminder">REMINDER</span>
                                <span th:if="${notification.type.name() == 'ALERT'}" class="type-pill type-alert">ALERT</span>
                            </td>
                            <td th:if="${notification.status == 'SUCCEEDED'}"><span th:text="${notification.status}"
                                                                                    class="status succeeded">Succeeded</span>
                            </td>
                            <td th:if="${notification.status == 'FAILED'}"><span th:text="${notification.status}"
                                                                                 class="status failed">Succeeded</span>
                            </td>
                            <td th:text="${#temporals.format(notification.createdOn, 'dd MMM HH:mm')}"
                                class="notification-date">Today, 10:30 AM
                            </td>
                        </tr>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="settings-panel">
            <h2 class="settings-title">Notification Settings</h2>

            <form th:action="@{'/notifications/' + ${user.id} + '/preferences'}" th:method="PATCH" th:object="${editPreferenceRequest}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                
                <div class="setting-item">
                    <span class="setting-label">Email Notifications</span>
                    <label class="switch">
                        <input type="checkbox"
                               id="emailToggle"
                               th:field="*{emailNotificationEnabled}">
                        <span class="slider">
                            <span class="slider-thumb"></span>
                        </span>
                    </label>
                </div>

                <div class="setting-item">
                    <span class="setting-label">Deadline Alerts</span>
                    <label class="switch">
                        <input type="checkbox"
                               id="deadlineToggle"
                               th:field="*{deadLineNotificationEnabled}">
                        <span class="slider">
                            <span class="slider-thumb"></span>
                        </span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Daily Summary</span>
                    <label class="switch">
                        <input type="checkbox"
                               id="summaryToggle"
                               th:field="*{summaryNotificationEnabled}">
                        <span class="slider">
                            <span class="slider-thumb"></span>
                        </span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Reminder Alerts</span>
                    <label class="switch">
                        <input type="checkbox"
                               id="reminderToggle"
                               th:field="*{reminderNotificationEnabled}">
                        <span class="slider">
                            <span class="slider-thumb"></span>
                        </span>
                    </label>
                </div>
                <button type="submit" class="change-preferences-btn">Save changes</button>
            </form>
        </div>
    </div>

</main>

<script>
(function() {
    function initToggles() {
        var inputs = document.querySelectorAll('.switch input[type="checkbox"]');
        
        for (var i = 0; i < inputs.length; i++) {
            (function(input) {
                var label = input.parentElement;
                var slider = label.querySelector('.slider');
                var thumb = slider ? slider.querySelector('.slider-thumb') : null;
                
                if (!slider || !thumb) return;
                
                function updateToggle() {
                    var isChecked = input.checked;
                    if (isChecked) {
                        slider.style.background = 'linear-gradient(135deg, #8b5cf6, #3b82f6)';
                        slider.style.boxShadow = '0 2px 8px rgba(139, 92, 246, 0.3)';
                        thumb.style.transform = 'translateX(24px)';
                    } else {
                        slider.style.background = '#e5e7eb';
                        slider.style.boxShadow = 'none';
                        thumb.style.transform = 'translateX(0)';
                    }
                }
                
                updateToggle();
                
                input.addEventListener('change', function() {
                    setTimeout(updateToggle, 0);
                });
                
                input.addEventListener('click', function() {
                    setTimeout(updateToggle, 0);
                });
            })(inputs[i]);
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initToggles);
    } else {
        initToggles();
    }
    
    setTimeout(initToggles, 500);
})();
</script>
</body>
</html>
