<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lifetime Analytics - TaskFlow</title>
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/analytics.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="sidebar-layout">

<aside class="sidebar" xmlns:sec="http://www.w3.org/1999/xhtml">
    <div class="sidebar-header">
        <h1 class="logo">TaskFlow</h1>
    </div>

    <nav class="nav">
        <a href="/dashboard" class="nav-link">
            <i class="fas fa-home"></i>
            Dashboard
        </a>
        <a href="/projects" class="nav-link">
            <i class="fas fa-folder"></i>
            Projects
        </a>
        <a href="/tasks" class="nav-link active">
            <i class="fas fa-tasks"></i>
            Tasks
        </a>
        <a href="/activity" class="nav-link">
            <i class="fas fa-chart-line"></i>
            Activity
        </a>
        <a href="/analytics" class="nav-link">
            <i class="fa-solid fa-chart-simple"></i>
            Analytics
        </a>
        <a href="/notifications" class="nav-link">
            <i class="fas fa-bell"></i>
            Notifications
        </a>
        <a th:href="@{'/users/' + ${user.id} + '/profile'}" class="nav-link">
            <i class="fas fa-cog"></i>
            Settings
        </a>
        <div sec:authorize="hasRole('ADMIN')">
            <a href="/users" class="nav-link">
                <i class="fa-solid fa-user"></i>
                Users
            </a>
        </div>
        <div sec:authorize="hasAnyRole('ADMIN','MODERATOR')">
            <a href="/notifications" class="nav-link">
                <i class="fa-solid fa-bullhorn"></i>
                Alerts
            </a>
        </div>
    </nav>

    <div class="user-profile">
        <img th:if="${base64Image != null}"
             th:src="'data:image/png;base64,' + ${base64Image}"
             class="user-avatar"
             alt="User Avatar">

        <div th:if="${base64Image == null}"
             th:text="${user.firstName.substring(0,1)} + ${user.lastName.substring(0,1)}"
             class="user-avatar">MS
        </div>

        <div class="user-info">
            <div th:text="${user.firstName + ' ' + user.lastName}" class="name"></div>
            <div th:text="${user.email}" class="email"></div>
        </div>

        <form th:action="@{/logout}" method="post">
            <button type="submit" class="logout-btn">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </form>
    </div>
</aside>

<main class="main">
    <header class="header">
        <div class="header-left">
            <h1 class="title">Lifetime Analytics</h1>
            <p class="subtitle">Complete overview of your all-time productivity metrics</p>
        </div>
        <div class="header-right">
            <a href="/analytics" class="btn-lifetime-analytics">
                <i class="fas fa-arrow-left"></i> Back to Analytics
            </a>
        </div>
    </header>

    <div class="content-wrapper">
        <div class="content-area analytics-page">

            <section class="lifetime-section">
                <div class="section-title">
                    <h2><i class="fas fa-tasks"></i> Lifetime Tasks Statistics</h2>
                    <p>All-time task performance and completion metrics</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon icon-purple"><i class="fa-solid fa-list-check"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Total Tasks</span>
                            <span th:text="${tasksAnalytics.lifetimeTotalTasks}" class="metric-value">0</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-green"><i class="fas fa-check-circle"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Completed Tasks</span>
                            <span th:text="${tasksAnalytics.lifetimeCompletedTasks}" class="metric-value">0</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-red"><i class="fas fa-times-circle"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Abandoned Tasks</span>
                            <span th:text="${tasksAnalytics.lifetimeAbandonedTasks}" class="metric-value">0</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-orange"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Overdue Tasks</span>
                            <span th:text="${tasksAnalytics.lifetimeOverdueTasks}" class="metric-value">0</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-blue"><i class="fas fa-clock"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Avg Completion Time</span>
                            <span th:text="${tasksAnalytics.lifetimeAverageCompletionTime} + ' days'" class="metric-value">0 days</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-green"><i class="fas fa-bolt"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Fastest Completion</span>
                            <span th:text="${tasksAnalytics.fastestCompletionTime} + ' hours'" class="metric-value">0 hours</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-pink"><i class="fas fa-percentage"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Completion Rate</span>
                            <span th:text="${tasksAnalytics.lifetimeCompletionRate} + '%'" class="metric-value">0%</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="lifetime-section">
                <div class="section-title">
                    <h2><i class="fas fa-folder"></i> Lifetime Projects Statistics</h2>
                    <p>All-time project performance and delivery metrics</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon icon-blue"><i class="fas fa-folder"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Total Projects</span>
                            <span th:text="${projectAnalytics.totalProjectsLifetime}" class="metric-value">0</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-green"><i class="fas fa-check-double"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Completed Projects</span>
                            <span th:text="${projectAnalytics.completedProjectsLifetime}" class="metric-value">0</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-red"><i class="fas fa-ban"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Abandoned Projects</span>
                            <span th:text="${projectAnalytics.abandonedProjectsLifetime}" class="metric-value">0</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-orange"><i class="fas fa-hourglass-half"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Avg Project Duration</span>
                            <span th:text="${projectAnalytics.averageProjectDurationLifetime} + ' days'" class="metric-value">0 days</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon icon-pink"><i class="fas fa-chart-line"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Project Completion Rate</span>
                            <span th:text="${projectAnalytics.projectCompletionRateLifetime} + '%'" class="metric-value">0%</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Tasks Breakdown</h3>
                        <p class="chart-subtitle">Lifetime task distribution</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="lifetimeTasksChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Projects Breakdown</h3>
                        <p class="chart-subtitle">Lifetime project distribution</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="lifetimeProjectsChart"></canvas>
                    </div>
                </div>
            </section>

        </div>
    </div>
</main>

<script th:inline="javascript">
    /*<![CDATA[*/
    const taskData = {
        total: /*[[${tasksAnalytics.lifetimeTotalTasks}]]*/ 0,
        completed: /*[[${tasksAnalytics.lifetimeCompletedTasks}]]*/ 0,
        abandoned: /*[[${tasksAnalytics.lifetimeAbandonedTasks}]]*/ 0,
        overdue: /*[[${tasksAnalytics.lifetimeOverdueTasks}]]*/ 0
    };

    const projectData = {
        total: /*[[${projectAnalytics.totalProjectsLifetime}]]*/ 0,
        completed: /*[[${projectAnalytics.completedProjectsLifetime}]]*/ 0,
        abandoned: /*[[${projectAnalytics.abandonedProjectsLifetime}]]*/ 0
    };
    /*]]>*/

    const createCenterTextPlugin = (totalValue) => ({
        id: 'centerText',
        beforeDraw: (chart) => {
            const ctx = chart.ctx;
            const total = totalValue || chart.data.datasets[0].data.reduce((a, b) => a + b, 0);

            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 28px Inter';
            ctx.fillStyle = '#1f2937';
            ctx.fillText(total, chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2,
                chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2 - 8);
            ctx.font = '600 13px Inter';
            ctx.fillStyle = '#6b7280';
            ctx.fillText('Total', chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2,
                chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2 + 16);
            ctx.restore();
        }
    });

    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: { padding: 12, font: { size: 12, weight: '600' }, usePointStyle: true, pointStyle: 'circle' }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 14, weight: '700' },
                bodyFont: { size: 13 }
            }
        }
    };

    new Chart(document.getElementById('lifetimeTasksChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Abandoned', 'Overdue'],
            datasets: [{
                data: [taskData.completed || 0, taskData.abandoned || 0, taskData.overdue || 0],
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                borderWidth: 0
            }]
        },
        options: chartOptions,
        plugins: [createCenterTextPlugin(taskData.total)]
    });

    new Chart(document.getElementById('lifetimeProjectsChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Abandoned'],
            datasets: [{
                data: [projectData.completed || 0, projectData.abandoned || 0],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: chartOptions,
        plugins: [createCenterTextPlugin(projectData.total)]
    });
</script>

</body>
</html>
